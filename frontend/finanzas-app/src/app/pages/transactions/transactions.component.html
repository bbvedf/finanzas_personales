<div class="page-container">
  <h2 class="page-title">Transacciones</h2>

  <div class="container">
    <!-- Formulario -->
    <div class="form-col">
      <div class="card form-card">
        <div class="form-field">
          <label for="user">Usuario</label>
          <select id="user" [(ngModel)]="userName" (change)="onUserNameChange()">
            <option value="">Selecciona un usuario</option>
            <option *ngFor="let u of users" [value]="u.username">{{ u.username }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="category">Categoría</label>
          <select id="category" [(ngModel)]="categoryName" (change)="onCategoryNameChange()">
            <option value="">Selecciona una categoría</option>
            <option *ngFor="let c of categories" [value]="c.name">{{ c.name }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="amount">Cantidad</label>
          <input id="amount" type="number" [(ngModel)]="amount" placeholder="Cantidad" />
        </div>

        <div class="form-field">
          <label for="description">Descripción</label>
          <input id="description" [(ngModel)]="description" placeholder="Descripción" />
        </div>

        <div class="form-field">
          <label for="date">Fecha</label>
          <input id="date" type="date" [(ngModel)]="date" placeholder="Fecha" />
        </div>

        <div class="form-buttons">
          <button *ngIf="currentTransactionId" class="button cancel-button" (click)="resetForm()">Cancelar</button>
          <button class="button" (click)="submitForm()">
            {{ currentTransactionId ? 'Actualizar' : 'Añadir' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-col">
      <div class="table-card">
        <div class="table-wrapper">
          <div class="table-caption">
            <button class="button" (click)="clearFilters()">Quitar filtros</button>
            <div class="search-container">
              <input type="text" placeholder="Buscar..." (input)="filterGlobal($event)" />
            </div>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>
                  Usuario
                  <ng-container *ngTemplateOutlet="iconGroup; context: { field: 'username' }"></ng-container>
                  <div *ngIf="activeFilter === 'username'" class="filter-overlay">
                    <ng-container
                      *ngTemplateOutlet="textFilter; context: { field: 'username', placeholder: 'Filtrar usuario' }"></ng-container>
                  </div>
                </th>

                <th>
                  Categoría
                  <ng-container *ngTemplateOutlet="iconGroup; context: { field: 'category_name' }"></ng-container>
                  <div *ngIf="activeFilter === 'category_name'" class="filter-overlay">
                    <ng-container
                      *ngTemplateOutlet="textFilter; context: { field: 'category_name', placeholder: 'Filtrar categoría' }"></ng-container>
                  </div>
                </th>

                <th>
                  Cantidad
                  <ng-container *ngTemplateOutlet="iconGroup; context: { field: 'amount' }"></ng-container>
                  <div *ngIf="activeFilter === 'amount'" class="filter-overlay">
                    <ng-container *ngTemplateOutlet="numberFilter; context: { field: 'amount' }"></ng-container>
                  </div>
                </th>

                <th>
                  Descripción
                  <ng-container *ngTemplateOutlet="iconGroup; context: { field: 'description' }"></ng-container>
                  <div *ngIf="activeFilter === 'description'" class="filter-overlay">
                    <ng-container
                      *ngTemplateOutlet="textFilter; context: { field: 'description', placeholder: 'Filtrar descripción' }"></ng-container>
                  </div>
                </th>

                <th>
                  Fecha
                  <ng-container *ngTemplateOutlet="iconGroup; context: { field: 'date' }"></ng-container>
                  <div *ngIf="activeFilter === 'date'" class="filter-overlay">
                    <ng-container *ngTemplateOutlet="dateFilter; context: { field: 'date' }"></ng-container>
                  </div>
                </th>

                <th>Acciones</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let tx of pagedTransactions">
                <td>{{ tx.username }}</td>
                <td>{{ tx.category_name }}</td>
                <td>{{ tx.amount }}</td>
                <td>{{ tx.description }}</td>
                <td>{{ formatDateForDisplay(tx.date) }}</td>
                <td>
                  <button class="icon-button edit-button" (click)="editTransaction(tx)">
                    <i class="bi bi-pencil-fill"></i>
                  </button>
                  <button class="icon-button delete-button" (click)="handleDeleteClick(tx)">
                    <i class="bi bi-trash-fill"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="filteredTransactions.length === 0">
                <td colspan="6">No se encontraron transacciones.</td>
              </tr>
            </tbody>
          </table>

          <app-pagination [totalItems]="filteredTransactions.length" [pageSize]="pageSize" [currentPage]="currentPage"
            (pageChange)="currentPage = $event; updatePagedTransactions()"
            (pageSizeChange)="pageSize = $event; currentPage = 1; updatePagedTransactions()"></app-pagination>


        </div>
        <div class="export-container">
          <button class="button export-button" (click)="showExportMenu = !showExportMenu">
            <i class="bi" [class.bi-download]="!showExportMenu" [class.bi-x]="showExportMenu"></i>
            {{ showExportMenu ? 'Cancelar' : 'Exportar' }}
          </button>

          <div class="export-menu" *ngIf="showExportMenu" [class.right-edge]="isRightEdge()">
            <button (click)="exportCSV()"><i class="bi bi-filetype-csv"></i> CSV</button>
            <button (click)="exportExcel()"><i class="bi bi-file-earmark-excel"></i> Excel</button>
            <button (click)="exportPDF()"><i class="bi bi-filetype-pdf"></i> PDF</button>
            <button (click)="exportEmail()"><i class="bi bi-envelope"></i> Email</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal-backdrop" *ngIf="showDeleteModal">
      <div class="modal">
        <h3>Confirmar eliminación</h3>
        <p>
          ¿Seguro que deseas eliminar la transacción
          <strong>{{ transactionToDelete?.description }}</strong>?
        </p>
        <div class="modal-buttons">
          <button class="button cancel-button" (click)="closeDeleteModal()">Cancelar</button>
          <button class="button delete-button" (click)="confirmDelete()">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Templates reutilizables -->
<!-- Grupo de iconos -->
<ng-template #iconGroup let-field="field">
  <div class="icon-group">
    <button class="filter-icon" (click)="toggleFilter(field)">
      <i
        class="{{ filters[field].value || filters[field].min || filters[field].max || filters[field].start || filters[field].end ? 'bi bi-funnel-fill' : 'bi bi-funnel' }}"></i>
    </button>
    <button class="sort-icon" (click)="toggleSort(field)">
      <i [ngClass]="{
        'bi bi-arrow-down-up': !filters[field].sortDirection,
        'bi bi-sort-up': filters[field].sortDirection === 'asc',
        'bi bi-sort-down': filters[field].sortDirection === 'desc'
      }"></i>
    </button>
  </div>
</ng-template>

<!-- Filtro de texto -->
<ng-template #textFilter let-field="field" let-placeholder="placeholder">
  <select [(ngModel)]="tempFilters[field].matchMode">
    <option value="all">Coincidir todos</option>
    <option value="any">Coincidir cualquiera</option>
  </select>
  <select [(ngModel)]="tempFilters[field].mode">
    <option value="contains">Contiene</option>
    <option value="startsWith">Comienza con</option>
    <option value="endsWith">Termina con</option>
    <option value="equals">Igual a</option>
  </select>
  <input type="text" [(ngModel)]="tempFilters[field].value" [placeholder]="placeholder" />
  <ng-container *ngTemplateOutlet="filterButtons"></ng-container>
</ng-template>

<!-- Filtro numérico -->
<ng-template #numberFilter let-field="field">
  <input type="number" [(ngModel)]="tempFilters[field].min" placeholder="Mínimo" />
  <input type="number" [(ngModel)]="tempFilters[field].max" placeholder="Máximo" />
  <ng-container *ngTemplateOutlet="filterButtons"></ng-container>
</ng-template>

<!-- Filtro de fecha -->
<ng-template #dateFilter let-field="field">
  <input type="date" [(ngModel)]="tempFilters[field].start" placeholder="Desde" />
  <input type="date" [(ngModel)]="tempFilters[field].end" placeholder="Hasta" />
  <ng-container *ngTemplateOutlet="filterButtons"></ng-container>
</ng-template>

<!-- Botones de filtro -->
<ng-template #filterButtons>
  <div class="filter-buttons">
    <button class="button cancel-button" (click)="cancelFilter()">Cancelar</button>
    <button class="button" (click)="applyFilter()">Aplicar</button>
  </div>
</ng-template>