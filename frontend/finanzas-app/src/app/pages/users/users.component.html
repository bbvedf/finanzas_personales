<div class="page-container">
  <h2 class="page-title">Usuarios</h2>

  <div class="container">
    <!-- Formulario -->
    <div class="form-col">
      <div class="card form-card">
        <div class="form-field">
          <label for="username">Username</label>
          <input id="username" [(ngModel)]="username" placeholder="Username">
        </div>
        <div class="form-field">
          <label for="email">Email</label>
          <input id="email" [(ngModel)]="email" type="email" placeholder="Email">
        </div>
        <div class="form-buttons">
          <button *ngIf="currentUserId" class="button cancel-button" (click)="resetForm()">Cancelar</button>
          <button class="button" (click)="submitForm()">
            {{ currentUserId ? 'Actualizar' : 'Añadir' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-col">
      <div class="table-card">
        <div class="table-wrapper">
          <div class="table-caption">
            <button class="button" (click)="clearFilters()">Quitar filtros</button>
            <div class="search-container">
              <input type="text" placeholder="Buscar..." (input)="filterGlobal($event)" />
            </div>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>
                  Username
                  <ng-container *ngTemplateOutlet="iconGroup; context: { field: 'username' }"></ng-container>
                  <div *ngIf="activeFilter === 'username'" class="filter-overlay">
                    <ng-container *ngTemplateOutlet="textFilter; context: { field: 'username', placeholder: 'Filtrar username' }"></ng-container>
                  </div>
                </th>
                <th>
                  Email
                  <ng-container *ngTemplateOutlet="iconGroup; context: { field: 'email' }"></ng-container>
                  <div *ngIf="activeFilter === 'email'" class="filter-overlay">
                    <ng-container *ngTemplateOutlet="textFilter; context: { field: 'email', placeholder: 'Filtrar email' }"></ng-container>
                  </div>
                </th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of pagedUsers">
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <button class="icon-button edit-button" (click)="editUser(user)">
                    <i class="bi bi-pencil-fill"></i>
                  </button>
                  <button class="icon-button delete-button" (click)="handleDeleteClick(user)">
                    <i class="bi bi-trash-fill"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="filteredUsers.length === 0">
                <td colspan="3">No se encontraron usuarios.</td>
              </tr>
            </tbody>
          </table>

          <app-pagination
            [totalItems]="filteredUsers.length"
            [pageSize]="pageSize"
            [currentPage]="currentPage"
            (pageChange)="currentPage = $event; updatePagedUsers()"
            (pageSizeChange)="pageSize = $event; currentPage = 1; updatePagedUsers()"
          ></app-pagination>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación -->
<div class="modal-backdrop" *ngIf="showDeleteModal">
  <div class="modal">
    <h3>Confirmar eliminación</h3>
    <p>¿Seguro que deseas eliminar al usuario <strong>{{ userToDelete?.username }}</strong>?</p>

    <div class="modal-buttons">
      <button class="button cancel-button" (click)="closeDeleteModal()">Cancelar</button>
      <button class="button delete-button" (click)="confirmDelete()">Eliminar</button>
    </div>
  </div>
</div>

<!-- Templates reutilizables -->
<ng-template #iconGroup let-field="field">
  <div class="icon-group">
    <button class="filter-icon" (click)="toggleFilter(field)">
      <i class="{{ filters[field].value ? 'bi bi-funnel-fill' : 'bi bi-funnel' }}"></i>
    </button>
    <button class="sort-icon" (click)="toggleSort(field)">
      <i [ngClass]="{
        'bi bi-arrow-down-up': !filters[field].sortDirection,
        'bi bi-sort-up': filters[field].sortDirection === 'asc',
        'bi bi-sort-down': filters[field].sortDirection === 'desc'
      }"></i>
    </button>
  </div>
</ng-template>

<ng-template #textFilter let-field="field" let-placeholder="placeholder">
  <select [(ngModel)]="tempFilters[field].matchMode">
    <option value="all">Coincidir todos</option>
    <option value="any">Coincidir cualquiera</option>
  </select>
  <select [(ngModel)]="tempFilters[field].mode">
    <option value="contains">Contiene</option>
    <option value="startsWith">Comienza con</option>
    <option value="endsWith">Termina con</option>
    <option value="equals">Igual a</option>
  </select>
  <input type="text" [(ngModel)]="tempFilters[field].value" [placeholder]="placeholder" />
  <ng-container *ngTemplateOutlet="filterButtons"></ng-container>
</ng-template>

<ng-template #filterButtons>
  <div class="filter-buttons">
    <button class="button cancel-button" (click)="cancelFilter()">Cancelar</button>
    <button class="button" (click)="applyFilter()">Aplicar</button>
  </div>
</ng-template>
